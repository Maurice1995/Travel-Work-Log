function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'addEntry') {
      const sheet = SpreadsheetApp.openById(data.sheetId).getSheetByName(data.sheetName);
      
      // Format data as text to prevent automatic date/time conversion
      const dateText = "'" + data.data.date; // Prefix with ' to force text format
      const timeText = "'" + data.data.time; // Prefix with ' to force text format
      
      // Add the new entry with customer field
      sheet.appendRow([
        dateText,
        timeText,
        data.data.customer,
        data.data.activity,
        data.data.description,
        data.data.location
      ]);
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: 'Entry added successfully'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: 'Unknown action'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: 'Error: ' + error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    if (e.parameter.action === 'getEntries') {
      const sheet = SpreadsheetApp.openById(e.parameter.sheetId).getSheetByName(e.parameter.sheetName);
      const data = sheet.getDataRange().getValues();
      
      if (data.length <= 1) {
        return ContentService
          .createTextOutput(JSON.stringify([]))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const headers = data[0];
      const entries = data.slice(1).reverse().map(row => { // Reverse to show newest first
        const entry = {};
        headers.forEach((header, index) => {
          // Clean up header names and map to expected field names
          let fieldName = header.toLowerCase().replace(/\s+/g, '');
          
          // Map common variations
          if (fieldName === 'customer/project' || fieldName === 'customerproject') {
            fieldName = 'customer';
          }
          
          let value = row[index] || '';
          
          // Clean up date and time values - remove any unwanted characters
          if (fieldName === 'date' || fieldName === 'time') {
            // Convert to string and clean
            value = String(value);
            
            // If it's a Date object, format it properly
            if (value.includes('GMT') || value.includes('UTC') || value.length > 20) {
              try {
                const dateObj = new Date(value);
                if (fieldName === 'date' && !isNaN(dateObj.getTime())) {
                  // Format as DD.MM.YYYY
                  const day = String(dateObj.getDate()).padStart(2, '0');
                  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                  const year = dateObj.getFullYear();
                  value = `${day}.${month}.${year}`;
                } else if (fieldName === 'time' && !isNaN(dateObj.getTime())) {
                  // Format as HH:MM
                  const hours = String(dateObj.getHours()).padStart(2, '0');
                  const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                  value = `${hours}:${minutes}`;
                }
              } catch (e) {
                // Keep original value if conversion fails
              }
            }
            
            // Remove leading apostrophe if present (from our text formatting)
            if (value.startsWith("'")) {
              value = value.substring(1);
            }
          }
          
          entry[fieldName] = value;
        });
        return entry;
      });
      
      return ContentService
        .createTextOutput(JSON.stringify(entries))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({error: 'No action specified'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Test function to verify the script works
function testScript() {
  console.log('Google Apps Script is working!');
}
